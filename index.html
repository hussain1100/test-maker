<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مولّد اختبار Google Forms</title>
<style>
body {
  font-family: 'Tahoma', sans-serif;
  background: #f4f8fb;
  color: #222;
  max-width: 900px;
  margin: auto;
  padding: 20px;
  direction: rtl;
}
header {
  text-align: center;
  margin-bottom: 20px;
}
h1 { color: #0a74da; }
label { display: block; margin-top: 15px; font-weight: bold; }
textarea, select, input[type=number] {
  width: 100%;
  padding: 10px;
  margin-top: 5px;
  border: 1px solid #c7d6e5;
  border-radius: 8px;
  box-sizing: border-box;
  background: #fff;
}
textarea#output {
  background: #e8f0fe;
  font-family: monospace;
}
button {
  background: #0a74da;
  color: #fff;
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  margin-top: 20px;
  font-size: 16px;
}
button:hover { background: #095bb5; }
footer {
  text-align: center;
  margin-top: 30px;
  font-size: 14px;
  color: #555;
}
</style>
</head>
<body>
  <header>
    <h1>مولّد اختبار Google Forms</h1>
    <p>انسخ أسئلتك ثم أدخل الإجابات الصحيحة بالترتيب وسيُنشأ كود Apps Script جاهز.</p>
  </header>

  <main>
    <label>١) أدخل نص الأسئلة والخيارات:</label>
    <textarea id="questions" rows="12" placeholder="1. السؤال الأول |2\nأ. خيار\nب. خيار\nج. خيار\n2. السؤال الثاني...\nأ. ..."></textarea>

    <label>٢) أدخل الإجابات الصحيحة بالترتيب (سطر لكل سؤال):</label>
    <textarea id="answers" rows="8" placeholder="ب\nب\nج\nالسماء"></textarea>

    <label>٣) الدرجة:</label>
    <select id="gradeType">
      <option value="single">درجة موحّدة لكل الأسئلة</option>
      <option value="per">درجات فردية (| بعد السؤال)</option>
    </select>

    <div id="singleGradeDiv">
      <input type="number" id="singleGrade" value="1" min="0.5" step="0.5"> درجة لكل سؤال
    </div>

    <label>٤) إظهار النتيجة مباشرة بعد الاختبار؟</label>
    <select id="release">
      <option value="later">لا، بعد المراجعة</option>
      <option value="immediate">نعم، مباشرة</option>
    </select>

    <button id="generate">إنشاء الكود</button>

    <h2>الكود الناتج:</h2>
    <textarea id="output" rows="20" readonly></textarea>
  </main>

  <footer>
    <p>مجاني 100% – انسخ الكود وضعه في <a href="https://script.google.com/" target="_blank">script.google.com</a></p>
  </footer>

<script>
// ====== وظائف مساعدة ======
function parseQuestions(raw) {
  const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const questions = [];
  let current = null;

  lines.forEach(line => {
    // بداية سؤال
    if (/^\d+[\.\-)]/.test(line)) {
      if (current) questions.push(current);
      const parts = line.split('|'); // دعم درجة فردية
      const qText = parts[0].replace(/^\d+[\.\-)]\s*/, '').trim();
      const qGrade = parts[1] ? parseFloat(parts[1]) : null;
      current = {text: qText, grade: qGrade, options: []};
    }
    // خيار
    else if (/^[أ-يA-Da-d]\s*[\.\)]/.test(line)) {
      if (current) current.options.push(line.replace(/^[أ-يA-Da-d]\s*[\.\)]\s*/, '').trim());
    }
    else {
      if (current) current.text += " " + line;
    }
  });
  if (current) questions.push(current);
  return questions;
}

function parseAnswers(raw) {
  return raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
}

function escapeString(str){
  return str.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
}

function generateAppsScript(questions, answers, gradeType, singleGrade, release) {
  let code = `function createQuiz(){\n`;
  code += `  const form = FormApp.create('اختبار جديد');\n`;
  code += `  form.setIsQuiz(true);\n`;

  if(release === 'immediate'){
    code += `  // ملاحظة: لا يمكن ضبط خيار النتيجة الفورية عبر الكود مباشرة.\n`;
    code += `  // بعد الإنشاء افتح الإعدادات واختر "Release immediately".\n`;
  }

  code += `\n  // إضافة الأسئلة\n`;

  questions.forEach((q, i) => {
    const grade = gradeType==='single' ? singleGrade : (q.grade || singleGrade);
    const ans = answers[i] || '';
    if (q.options.length === 0) {
      // سؤال نصي
      code += `  {\n    const item = form.addTextItem();\n    item.setTitle('${escapeString(q.text)}').setRequired(true).setPoints(${grade});\n`;
      if (ans) code += `    item.setHelpText('الإجابة النموذجية: ${escapeString(ans)}');\n`;
      code += `  }\n`;
    } else {
      // سؤال اختيار
      let correctIndex = -1;
      if (ans) {
        const letters = ['أ','ا','ب','ج','د','ه','هـ','و','ز','A','B','C','D','E'];
        const idx = letters.findIndex(l=>l.toUpperCase()===ans[0].toUpperCase());
        if (idx>=0) correctIndex = idx;
      }
      code += `  {\n    const item = form.addMultipleChoiceItem();\n    item.setTitle('${escapeString(q.text)}').setRequired(true).setPoints(${grade});\n`;
      code += `    const choices = [\n`;
      q.options.forEach((opt,j)=>{
        const correct = (j===correctIndex) ? ', true' : '';
        code += `      item.createChoice('${escapeString(opt)}'${correct}),\n`;
      });
      code += `    ];\n    item.setChoices(choices);\n  }\n`;
    }
  });

  code += `\n  Logger.log('تم إنشاء الاختبار: ' + form.getEditUrl());\n`;
  code += `}\n`;
  return code;
}

// ====== ربط الواجهة ======
document.getElementById('generate').addEventListener('click', ()=>{
  const qRaw = document.getElementById('questions').value;
  const aRaw = document.getElementById('answers').value;
  const gradeType = document.getElementById('gradeType').value;
  const singleGrade = parseFloat(document.getElementById('singleGrade').value) || 1;
  const release = document.getElementById('release').value;

  const questions = parseQuestions(qRaw);
  const answers = parseAnswers(aRaw);

  if (answers.length < questions.length){
    alert('⚠️ عدد الإجابات أقل من عدد الأسئلة. سيتم اعتبار الباقي بلا إجابة.');
  }

  const code = generateAppsScript(questions, answers, gradeType, singleGrade, release);
  document.getElementById('output').value = code;
});

// إظهار/إخفاء خانة الدرجة الموحدة
document.getElementById('gradeType').addEventListener('change', (e)=>{
  document.getElementById('singleGradeDiv').style.display =
    e.target.value === 'single' ? 'block' : 'none';
});
</script>
</body>
</html>
