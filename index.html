<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>مُنشئ اختبار مباشر</title>
<style>
:root{--blue:#0b66ff;--midblue:#0b5ae6;--soft:#f3f8ff;--white:#ffffff}
*{box-sizing:border-box;font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif}
body{margin:0;background:linear-gradient(180deg,var(--soft),#fff);color:#0b2340}
.wrap{max-width:980px;margin:28px auto;padding:20px;background:var(--white);border-radius:16px;box-shadow:0 10px 30px rgba(11,38,64,0.08)}
header{display:flex;gap:16px;align-items:center}
.logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--blue),var(--midblue));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
h1{margin:0;font-size:20px}
p.lead{margin:6px 0 18px;color:#234}
textarea,input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d7e6ff;background:#fff;font-size:14px}
textarea{min-height:200px;resize:vertical}
.btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--blue);color:#fff;border:none;cursor:pointer;margin-top:6px}
.btn.secondary{background:transparent;color:var(--blue);border:1px solid rgba(11,102,255,0.14)}
.output{white-space:pre-wrap;background:#0b102033;padding:10px;border-radius:8px;overflow:auto;font-family:monospace;font-size:13px;margin-top:12px}
.card{background:linear-gradient(180deg,#fff,#fbfdff);padding:14px;border-radius:12px;border:1px solid rgba(11,102,255,0.06);margin-bottom:16px}
.q{margin-bottom:12px}
.opt{display:block;margin:4px 0}
.result{background:#f0f7ff;padding:12px;border-radius:8px;margin-top:12px;font-weight:600}
</style>
</head>
<body>
<div class="wrap">
<header>
<div class="logo">Q</div>
<div>
<h1>مُنشئ اختبار مباشر</h1>
<p class="lead">ألصق أسئلتك أدناه، اضغط "إنشاء الاختبار"، ثم قم بالإجابة مباشرة في الأسفل.</p>
</div>
</header>

<div class="card">
<label>ألصق الأسئلة هنا (أو استخدم الصيغة المختصرة):</label>
<textarea id="inputText" placeholder="مثال:
1.ما هو مجموع 2+2؟
أ.3
ب.4
ج.5
2.ضع تعريف الإيمان:
TEXT:
الإيمان هو ..."></textarea>

<label>درجة موحدة لكل الأسئلة (0 للسماح بدرجات فردية):</label>
<input type="number" id="uniformPoints" placeholder="مثلاً 2">

<div style="display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn" id="generateQuiz">إنشاء الاختبار</button>
<button class="btn secondary" id="clearAll">مسح كل شيء</button>
</div>
</div>

<div class="card" id="quizContainer" style="display:none;">
<h2>الاختبار</h2>
<form id="quizForm"></form>
<button class="btn" id="submitQuiz" style="display:none">إرسال الإجابات</button>
<div id="quizResult"></div>
</div>
</div>

<script>
// --- Helpers ---
function trim(s){return s?s.trim():''}
function startsWithLetterDot(line){return /^[\u0621-\u06FFA-Za-z]\s*[\.|\)]/.test(line)}

function parseInput(text){
  let lines = text.replace(/\r/g,'').split('\n');
  let questions = [];
  let i=0;
  while(i<lines.length){
    let line = trim(lines[i]);
    if(!line){i++;continue;}
    if(line.includes('|')){
      let parts = line.split('|').map(trim);
      let qtext = parts[0];
      let choices = parts[1]? parts[1].split(';').map(trim):[];
      let answerChar = parts[2]? parts[2].trim():'';
      let points = parts[3]? parseFloat(parts[3]):0;
      let correctIndex = -1;
      if(answerChar){
        let map={'أ':0,'ا':0,'a':0,'A':0,'ب':1,'b':1,'B':1,'ج':2,'c':2,'C':2,'د':3,'d':3,'D':3};
        if(map[answerChar[0]]!==undefined) correctIndex=map[answerChar[0]];
      }
      questions.push({type:choices.length?'mcq':'text',question:qtext,choices,correctIndex,points});
      i++; continue;
    }
    let qLine = line;
    let m = qLine.match(/^\d+\.?\s*(.*)$/);
    if(m) qLine = m[1];
    let q={type:'mcq',question:qLine,choices:[],correctIndex:-1,points:0};
    i++;
    while(i<lines.length){
      let nxt = trim(lines[i]); if(!nxt){i++;continue;}
      if(/^\d+\.?\s+/.test(nxt)) break;
      if(nxt.includes('|')) break;
      if(nxt.toUpperCase().startsWith('TEXT:')){
        let ans = nxt.substring(5).trim();
        if(!ans){i++;if(i<lines.length){ans=trim(lines[i]);}}
        q.type='text'; q.answerText=ans; i++; break;
      }
      if(startsWithLetterDot(nxt) || /^[أابجدة]\./.test(nxt)){
        let opt = nxt.replace(/^[\u0621-\u06FFA-Za-z]\s*[\.|\)]/,'').trim();
        let correct=/[✓✔\(صح\)]/.test(nxt);
        q.choices.push(opt);
        if(correct) q.correctIndex = q.choices.length-1;
        i++; continue;
      }
      if(q.choices.length===0){q.question+=' '+nxt;i++; continue;}
      break;
    }
    questions.push(q);
  }
  return questions;
}

// --- Generate Quiz ---
document.getElementById('generateQuiz').addEventListener('click',()=>{
  let text=document.getElementById('inputText').value;
  if(!trim(text)){alert('ألصق الأسئلة أولاً'); return;}
  let uniform=parseFloat(document.getElementById('uniformPoints').value)||0;
  let questions=parseInput(text);
  if(uniform>0){questions.forEach(q=>q.points=uniform);}
  let form=document.getElementById('quizForm');
  form.innerHTML='';
  questions.forEach((q,idx)=>{
    let div=document.createElement('div'); div.className='q';
    let qtitle=document.createElement('div'); qtitle.innerHTML='<strong>السؤال '+(idx+1)+':</strong> '+q.question; div.appendChild(qtitle);
    if(q.type==='mcq'){
      q.choices.forEach((c,chIdx)=>{
        let label=document.createElement('label'); label.className='opt';
        label.innerHTML=`<input type="radio" name="q${idx}" value="${chIdx}"> ${c}`;
        div.appendChild(label);
      });
    } else{
      let ta=document.createElement('textarea');
      ta.name='q'+idx;
      ta.style.width='100%'; ta.style.height='80px'; ta.placeholder='أكتب إجابتك هنا...';
      div.appendChild(ta);
    }
    form.appendChild(div);
  });
  document.getElementById('quizContainer').style.display='block';
  document.getElementById('submitQuiz').style.display='inline-block';
  document.getElementById('quizResult').innerHTML='';
  window.currentQuestions=questions;
});

// --- Submit Quiz ---
document.getElementById('submitQuiz').addEventListener('click',()=>{
  let questions=window.currentQuestions||[];
  let score=0, max=0;
  questions.forEach((q,idx)=>{
    let pts = q.points||1; max+=pts;
    if(q.type==='mcq'){
      let val=document.querySelector(`input[name="q${idx}"]:checked`);
      let chosen=val?parseInt(val.value):-1;
      if(chosen===q.correctIndex) score+=pts;
    } else{
      let val=document.querySelector(`[name="q${idx}"]`).value.trim();
      if(q.answerText && val===q.answerText) score+=pts;
    }
  });
  document.getElementById('quizResult').innerHTML=`<div class="result">الدرجة: ${score} من ${max}</div>`;
});

// --- Clear ---
document.getElementById('clearAll').addEventListener('click',()=>{
  document.getElementById('inputText').value='';
  document.getElementById('uniformPoints').value='';
  document.getElementById('quizContainer').style.display='none';
  document.getElementById('quizForm').innerHTML='';
  document.getElementById('quizResult').innerHTML='';
});
</script>
</body>
</html>
